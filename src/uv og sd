/*
  Using the AMS AS7331 Spectral UV Sensor in Command/One Shot (CMD) Mode.

  This example shows how operate the AS7331 in the default CMD mode. The start
  command is sent, then delays until the conversion time has passed before
  reading out the UV values.

  By: Alex Brudner
  SparkFun Electronics
  Date: 2023/11/17
  SparkFun code, firmware, and software is released under the MIT License.
    Please see LICENSE.md for further details.

  Hardware Connections:
  IoT RedBoard --> AS7331
  QWIIC --> QWIIC

  Serial.print it out at 115200 baud to serial monitor.

  Feel like supporting our work? Buy a board from SparkFun!
  https://www.sparkfun.com/products/23517 - Qwiic 1x1
  https://www.sparkfun.com/products/23518 - Qwiic Mini
*/

#include <Arduino.h>
#include <SparkFun_AS7331.h>
#include <Wire.h>
#include <SD.h>

SfeAS7331ArdI2C myUVSensor;
const int chipSelect = 10;
int sensorverdier[10];
int i = 0;
File myFile;




void setup() {
    Serial.begin(115200);
    //Initialiserer serial-kommunikasjon med baud rate 9600 bps
 
  //Feilmelding ved mislykket initialisering av serial-kommunikasjon
  if (!SD.begin(chipSelect)) {
    Serial.println("Initialisering av serial-kommunikasjon feilet. Sjekk at alt det fysiske er koblet til riktig.");
    while (true);
  }

  //Sletter original-filen, fordi jeg har lagt til masse unødvendige linjer med tekst i .txt-filen eheh
  if ("EriksFil.txt") {
    SD.remove("EriksFil.txt");
  }

  //Åpner/lager en fil med navn "Eriks_testfil.txt". Åpner den i skrivemodus.
  myFile = SD.open("EriksFil.txt", FILE_WRITE);

  //Skriver til filen, dersom det funket å åpne/lage den
  if (myFile) {
    myFile.println("Erik Elahi Fidjeland har skrevet til denne filen:) \nHan er en ganske fet kar ellerhva? \nJeg tror faktisk han er topp 3 feteste/kjekkeste karer i Norge as");

    //Lukker filen
    myFile.close();
    //uv sensor
   }
    while (!Serial)
    {
        delay(100);
    }
    Serial.println("AS7331 UV A/B/C Command (One-shot) mode Example.");

    Wire.begin();

    // Initialize sensor and run default setup.
    if (myUVSensor.begin() == false)
    {
        Serial.println("Sensor failed to begin. Please check your wiring!");
        Serial.println("Halting...");
        while (1)
            ;
    }

    Serial.println("Sensor began.");

    // Set measurement mode and change device operating mode to measure.
    if (myUVSensor.prepareMeasurement(MEAS_MODE_CMD) == false)
    {
        Serial.println("Sensor did not get set properly.");
        Serial.println("Halting...");
        while (1)
            ;
    }

    Serial.println("Set mode to command.");
}

void loop() {
     
  int tilfeldigTall = random(0, 101);
  sensorverdier[i] = tilfeldigTall;
  i++;

  if (i == 10) {
    // Åpne filen for skriving
    myFile = SD.open("EriksFil.txt", FILE_WRITE);
    if (myFile) {
      for (int j = 0; j < 10; j++) {
        myFile.print(myUVSensor.getUVA());
        myFile.print(",");
        Serial.print(myUVSensor.getUVB());  // <-- skriver til Serial også
        Serial.print(",");
      }
      myFile.println();
      Serial.println(); // ny linje i Serial Monitor

      myFile.close(); // må lukke filen for å lagre
      i = 0;
    } else {
      Serial.println("Kunne ikke åpne fil for skriving");
    }
  }
//uv
    // Send a start measurement command.
    if (ksfTkErrOk != myUVSensor.setStartState(true))
        Serial.println("Error starting reading!");

    // Wait for a bit longer than the conversion time.
    delay(2 + myUVSensor.getConversionTimeMillis());

    // Read UV values.
    if (ksfTkErrOk != myUVSensor.readAllUV())
        Serial.println("Error reading UV.");

    Serial.print("UVA:");
    Serial.print(myUVSensor.getUVA());
    Serial.print(" UVB:");
    Serial.print(myUVSensor.getUVB());
    Serial.print(" UVC:");
    Serial.println(myUVSensor.getUVC());

    delay(2000);
}
